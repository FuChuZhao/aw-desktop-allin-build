name: ci-linux

on:
  workflow_dispatch:
    inputs:
      source_ref:
        description: "Private source ref/commit to test/build"
        required: true
        type: string
      artifact_name:
        description: "Artifact name"
        required: true
        type: string

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private source via SSH deploy key (read-only)
        uses: actions/checkout@v4
        with:
          repository: FuChuZhao/aw-desktop-allin-source
          ref: ${{ inputs.source_ref }}
          ssh-key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
          path: source
          submodules: recursive

      - name: Install Linux desktop build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            cmake \
            ninja-build \
            pkg-config \
            libgtk-3-dev \
            xvfb

          # tray_manager needs an AppIndicator implementation. Package names vary
          # across Ubuntu versions.
          sudo apt-get install -y libayatana-appindicator3-dev || sudo apt-get install -y libappindicator3-dev

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: CI (tests + screenshots + build)
        shell: bash
        working-directory: source
        run: |
          ./tool/ci/ci_linux.sh --out-dir dist --artifact-dir ci_artifacts

      - name: Upload artifact (minimal exposure)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: |
            source/dist/**
            source/ci_artifacts/**
          if-no-files-found: warn
          retention-days: 1
